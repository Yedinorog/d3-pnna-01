<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard de Proyectos con D3.js</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { font-family: Segoe UI Symbol, Segoe UI Symbol; background: #f5f5f5; }

    .summary-container {
      display: flex;
      justify-content: space-around;
      margin-bottom: 30px;
    }
    .summary-chart {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px #0002;
      text-align: center;
    }
    .chart-title {
      font-weight: bold;
      margin-bottom: 10px;
    }

    .mi-tabla {
      border-collapse: collapse;
      margin-bottom: 30px;
      background: #fff;
      box-shadow: 0 2px 8px #0002;
      width: 100%;
      max-width: 1500px;
    }
    .mi-tabla th, .mi-tabla td {
      border: 1px solid #ccc;
      padding: 8px 10px;
      text-align: center;
      font-size: 15px;
    }
    .mi-tabla th {
      background: #512b99;
      color: #fff;
    }
    .progress-container {
      width: 100px;
      height: 20px;
      background: #f0f0f0;
      position: relative;
      margin: 0 auto;
    }
    .progress-plan {
      height: 100%;
      background: #90caf9;
      position: absolute;
      top: 0;
      left: 0;
    }
    .progress-real {
      height: 100%;
      background: #1976d2;
      position: absolute;
      top: 0;
      left: 0;
    }
    .progress-label {
      position: absolute;
      width: 100%;
      text-align: center;
      line-height: 20px;
      font-size: 12px;
      color: #333;
    }
  </style>
</head>
<body>
  <h2>Tablero de Control PNNA</h2>

  <!-- Contenedor para los gráficos de resumen -->
  <div class="summary-container">
    <div id="avance-general-chart" class="summary-chart"></div>
    <div id="estados-chart" class="summary-chart"></div>
  </div>

  <div id="dashboard"></div>
  <script>

    // ============================================
    // Datos de la tabla
    // ============================================
    const tabla = [
      ["ONR","Descripción","Fecha I.","Estado actual","Avance según plan","Avance real","Observaciones"],
      ["AOP 02","SPJC: A-SMGCS","2023","En progreso","100","95","En actualización de procedimientos"],
      ["AOP 08","SPZO: ACIS","2022","En progreso","100","48","Lectura y validación de datos"],
      ["AOP 09","SPZO: Integracion aeródromo con ATM","2022","En progreso","100","48","Lectura y validación de datos"],
      ["AOP 11","Integracion seguridad operacional con ATS","2021","Completado","100","100","Mantenimiento plan integración"],
      ["ATM 01","Aproximaciones PBN RNP APCH","2024","Completado","100","100","Mantenimiento procedimientos"],
      ["ATM 02","Aproximaciones PBN RNP AR","2024","Completado","100","100","Mantenimiento procedimientos"],
      ["ATM 03","Aprox. PBN en SID y STAR c/ avanzadas","2024","Completado","100","100","Mantenimiento procedimientos"],
      ["ATM 04","Aprox. PBN en SID y STAR c/ avanzadas","2024","Completado","100","100","Mantenimiento procedimientos"],
      ["ATM 11","SPJC: Operaciones simultaneas RWY","2025","En progreso","80","80","Desarrollo procedimientos y pruebas"],
      ["ATM 12","SPIM: Espacio aéreo de ruta libre FRA","2023","Completado","100","100","Mantenimiento plan"],
      ["ATM 23","Intercambio automático de comunicaciones ATS","2021","Completado","100","100","Mantenimiento lista de verificación"],
      ["ATM 25","Alerta de Conflicto a Corto Plazo (STCA)","2023","Completado","100","100","Mantenimiento del plan"],
      ["ATM 27","Advertencia de Altitud Mínima de Seguridad (MSAW)","2023","Completado","100","100","Mantenimiento del plan"],
      ["ATM 28","Advertencia de proximidad de área (APW)","2023","Completado","100","100","Mantenimiento del plan"],
      ["ATM 29","Vigilancia de la trayectoria de aproximación (APM)","2023","Completado","100","100","Mantenimiento del plan"],
      ["ATM 31","CDM-ATFCM: Integración g. espacio a. c/ g. ATS","2021","Completado","100","100","Mantenimiento del plan"],
      ["ATM 32","Actualizacion de vuelo en la red","2023","Completado","100","100","Mantenimiento del plan"],
      ["ATM 34","Franjas horarias/ATFM e interfaz A-CDM","2023","Completado","100","100","Mantenimiento del plan"],
      ["ATM 41","Descentralización del C. Control Area Lima","2023","Completado","100","100","Mantenimiento del plan"],
      ["CNS 01","Vigilancia alterna con ADS-B espacio superior","2025","En progreso","100","29","Actualizacion Regulación"],
      ["CNS 02","MLAT","2025","En progreso","100","5","Toma de datos su validación"],
      ["CNS 05","AMHS","2021","En progreso","100","25","En planificación"],
      ["CNS 07","CPDLC p/ espacio a. bajo control procedimientos","2026","Completado","90","100","Mantenimiento plan"],
      ["CNS 08","ADS-C","2020","Completado","100","100","Mantenimiento plan"],
      ["AIM 01","S. Calidad de Suministro AIP","2023","En progreso","100","50","Fuente de datos no actualizada"],
      ["AIM 02","Suministro datos eAIP c/ AIXM","2023","En progreso","100","5","Sistemas no compatibles"],
      ["AIM 03","Suministro datos terremno c/ AIXM","2024","En progreso","100","5","Sistemas no compatibles"],
      ["AIM 04","Suministro datos obstaculos c/ AIXM","2024","En progreso","100","5","Sistemas no compatibles"],
      ["AIM 05","Suministro datos cartografia c/ AIXM","2023","En progreso","100","5","Sistemas no compatibles"],
      ["AIM 06","Suministro datos p/ procedimientos v. c/ AIXM","2024","En progreso","100","5","Sistemas no compatibles"],
    ];

    // ============================================
    // CÁLCULO DE DATOS PARA LOS GRÁFICOS CIRCULARES
    // ============================================

    // 1. Calcular el avance general promedio (promedio ponderado)
    let totalAvance = 0;
    let totalProyectos = 0;
    
    tabla.slice(1).forEach(row => {
      const avance = parseFloat(row[5]); // Avance real (columna 5)
      if (!isNaN(avance)) {
        totalAvance += avance;
        totalProyectos++;
      }
    });
    
    const avancePromedio = totalProyectos > 0 ? (totalAvance / totalProyectos) : 0;
    const avancePendiente = 100 - avancePromedio;
    
    // 2. Calcular distribución por estados
    const conteoEstados = { completados: 0, enProgreso: 0, retrasados: 0 };
    
    tabla.slice(1).forEach(row => {
      const estado = row[3].toLowerCase(); // Estado actual (columna 3)
      
      if (estado.includes("completado")) {
        conteoEstados.completados++;
      } else if (estado.includes("progreso")) {
        conteoEstados.enProgreso++;
      } else if (estado.includes("retrasado") || estado.includes("stand by")) {
        conteoEstados.retrasados++;
      }
    });
    
    const totalProyectosEstado = conteoEstados.completados + conteoEstados.enProgreso + conteoEstados.retrasados;

    // ============================================
    // Código para los nuevos gráficos circulares
    // ============================================
    
    // Datos para los gráficos (ahora calculados automáticamente)

    const avanceGeneralData = [
      { label: "Avanzado", value: avancePromedio, color: "#4CAF50" },
      { label: "Pendiente", value: avancePendiente, color: "#F44336" }
    ];
    
    const estadosData = [
      { label: "Completados", value: conteoEstados.completados, color: "#4CAF50" },
      { label: "En progreso", value: conteoEstados.enProgreso, color: "#FFC107" },
      { label: "Retrasados", value: conteoEstados.retrasados, color: "#F44336" }
    ];
        
    // Función para crear gráficos circulares
    function createDonutChart(containerId, data, title, showPercentage = false, decimals=0, width=150, height=150 ) {
      const radius = Math.min(width, height) / 2;
      const svg = d3.select(`#${containerId}`)
        .append("svg")
        .attr("width", width)
        .attr("height", height)
        .append("g")
        .attr("transform", `translate(${width/2},${height/2})`);
      
      // Añadir título
      d3.select(`#${containerId}`)
        .insert("div", ":first-child")
        .attr("class", "chart-title")
        .text(title);
      
      const pie = d3.pie()
        .value(d => d.value)
        .sort(null);
      
      const arc = d3.arc()
        .innerRadius(radius * 0.6) // Hacemos un donut chart (hueco en el centro)
        .outerRadius(radius * 0.9);
      
      const arcs = svg.selectAll(".arc")
        .data(pie(data))
        .enter()
        .append("g")
        .attr("class", "arc");
      
      arcs.append("path")
        .attr("d", arc)
        .attr("fill", d => d.data.color)
        .attr("stroke", "white")
        .style("stroke-width", "2px");
      
      // Añadir texto en el centro
      svg.append("text")
        .attr("text-anchor", "middle")
        .attr("dy", ".3em")
        .style("font-size", "20px")
        .style("font-weight", "bold")
        .text(data[0].label === "Avanzado" 
          ? `${avancePromedio.toFixed(decimals)}%` 
          : `${conteoEstados.completados}/${totalProyectosEstado}`);
      
      // Leyenda
      const legend = d3.select(`#${containerId}`)
        .append("div")
        .style("display", "flex")
        .style("flex-wrap", "wrap")
        .style("justify-content", "center")
        .style("margin-top", "8px");

     
      data.forEach(d => {
        if(d.value > 0) { // Solo mostramos items con valor
    	  const formattedValue = showPercentage ? d.value.toFixed(decimals) + "%" : d.value;
          legend.append("div")
            .html(`
              <div style="display:flex; align-items:center; margin:2px 5px;">
                <div style="width:12px;height:12px;background:${d.color};margin-right:5px;"></div>
                ${d.label}: ${formattedValue}
              </div>
            `);
        }
      });
    }
    
    // Crear los gráficos
    createDonutChart("avance-general-chart", avanceGeneralData, "Avance General Promedio",true ,0);
    createDonutChart("estados-chart", estadosData, "Distribución por Estado",false ,0);
    
    // Colores para los estados
    const estadoColor = {
      "Completado": "#4CAF50",   // verde
      "En progreso": "#FFC107",  // amarillo
      "Stand by": "#F44336"      // rojo
    };

    // Crear la tabla
    const table = d3.select("#dashboard").append("table").attr("class", "mi-tabla");
    const thead = table.append("thead");
    const tbody = table.append("tbody");

    // Encabezados
    thead.append("tr")
      .selectAll("th")
      .data(tabla[0].concat(["Avance gráfico"]))
      .enter()
      .append("th")
      .text(d => d);

    // Filas de datos
    const rows = tbody.selectAll("tr")
      .data(tabla.slice(1))
      .enter()
      .append("tr");

    // Celdas de datos
    rows.selectAll("td")
      .data(d => d.concat([null])) // Añadimos columna extra para el gráfico
      .enter()
      .append("td")
      .each(function(d, i) {
        // Estado con color
        if (i === 3) {
          d3.select(this)
            .style("background", estadoColor[d] || "#eee")
            .style("color", "#222")
            .text(d);
        }
        // Gráfico de barras horizontales
        else if (i === 7) {
          const row = d3.select(this);
          const plan = +d3.select(this.parentNode).datum()[4]; // Avance según plan (índice 4)
          const real = +d3.select(this.parentNode).datum()[5]; // Avance real (índice 5)
          
          const container = row.append("div").attr("class", "progress-container");
          
          container.append("div")
            .attr("class", "progress-plan")
            .style("width", plan + "%");
            
          container.append("div")
            .attr("class", "progress-real")
            .style("width", real + "%");
            
          container.append("div")
            .attr("class", "progress-label")
            .text(real + "%");
        }
        // Mostrar el avance según plan (columna 4) con el símbolo de porcentaje
        else if (i === 4) {
          d3.select(this).text(d + "%");
        }
        // Mostrar el avance real (columna 5) con el símbolo de porcentaje
        else if (i === 5) {
          d3.select(this).text(d + "%");
        }
        // Otras celdas normales
        else {
          d3.select(this).text(d);
        }
      });

    // Diagrama de barras inferior
    const barWidth = 1300, barHeight = 250;
    const dataBar = tabla.slice(1).map(d => ({
      proyecto: d[0],
      avance: d[5] // Usar Avance real (índice 5)
    }));

    const x = d3.scaleBand()
      .domain(dataBar.map(d => d.proyecto))
      .range([0, barWidth])
      .padding(0.5);

    const y = d3.scaleLinear()
      .domain([0, 100])
      .range([barHeight, 0]);

    // Aumentar el tamaño del SVG para acomodar las etiquetas rotadas
    const svgBar = d3.select("#dashboard")
      .append("svg")
      .attr("width", barWidth + 100)   // Aumenté el ancho para las etiquetas
      .attr("height", barHeight + 100)   // Aumenté la altura para las etiquetas
      .append("g")
      .attr("transform", "translate(60,30)");

    // Eje X
    svgBar.append("g")
      .attr("transform", `translate(0,${barHeight})`)
      .call(d3.axisBottom(x));

    // Eje Y
    svgBar.append("g")
      .call(d3.axisLeft(y).ticks(5).tickFormat(d => d + "%"));

    // Barras
    svgBar.selectAll(".bar")
      .data(dataBar)
      .enter()
      .append("rect")
      .attr("class", "bar")
      .attr("x", d => x(d.proyecto))
      .attr("y", d => y(d.avance))
      .attr("width", x.bandwidth())
      .attr("height", d => barHeight - y(d.avance))
      .attr("fill", "#1976d2");

    // Etiquetas encima de cada barra
    svgBar.selectAll(".bar-label")
      .data(dataBar)
      .enter()
      .append("text")
      .attr("class", "bar-label")
      .attr("x", d => x(d.proyecto) + x.bandwidth()/2)
      .attr("y", d => y(d.avance) - 5)
      .attr("text-anchor", "middle")
      .attr("fill", "#333")
      .attr("font-size", 8)
      .text(d => d.avance + "%");

    // Título del gráfico de barras
    svgBar.append("text")
      .attr("x", barWidth/2)
      .attr("y", -10)
      .attr("text-anchor", "middle")
      .attr("font-size", 16)
      .attr("fill", "#1976d2")
      .text("Avance Real por ONR");

  </script>
</body>
</html>
