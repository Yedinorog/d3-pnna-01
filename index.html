<!DOCTYPE html>		deepseek
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard de Proyectos con D3.js</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { font-family: Segoe UI Symbol, Segoe UI Symbol; background: #f5f5f5; }
    .summary-container { display: flex; justify-content: space-around; margin-bottom: 30px; }
    .summary-chart { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px #0002; text-align: center; }
    .chart-title { font-weight: bold; margin-bottom: 10px; }
    .mi-tabla { border-collapse: collapse; margin-bottom: 30px; background: #fff; box-shadow: 0 2px 8px #0002; width: 100%; max-width: 1400px; }
    .mi-tabla th, .mi-tabla td { border: 1px solid #ccc; padding: 4px 8px; text-align: center; font-size: 15px; }
    .mi-tabla th { background: #512b99; color: #fff; }
    .progress-container { width: 100px; height: 20px; background: #f0f0f0; position: relative; margin: 0 auto; }
    .progress-plan { height: 100%; background: #90caf9; position: absolute; top: 0; left: 0; }
    .progress-real { height: 100%; background: #1976d2; position: absolute; top: 0; left: 0; }
    .progress-label { position: absolute; width: 100%; text-align: center; line-height: 20px; font-size: 12px; color: #333; }
    .error-message { color: red; padding: 15px; background: #ffeeee; border: 1px solid red; margin: 20px; border-radius: 5px; }
  </style>
</head>
<body>
  <h2>Tablero de Control PNNA</h2>
  <div id="error-container"></div>

  <!-- Contenedor para los gráficos de resumen -->
  <div class="summary-container">
    <div id="avance-general-chart" class="summary-chart"></div>
    <div id="estados-chart" class="summary-chart"></div>
  </div>

  <div id="dashboard"></div>

  <script>
    // Colores para los estados
    const estadoColor = {
      "Completado": "#4CAF50",
      "En progreso": "#FFC107",
      "Stand by": "#F44336",
      "Retrasado": "#F44336"
    };

    // Función para mostrar errores
    function showError(message) {
      d3.select("#error-container").append("div")
        .attr("class", "error-message")
        .html(`<strong>Error:</strong> ${message}<br>
               Asegúrate que:<br>
               1. El archivo data.json existe en la raíz del repositorio<br>
               2. Tiene el formato JSON correcto`);
    }
    // Función para crear gráficos circulares
    function createDonutChart(containerId, data, title, showPercentage = false, decimals = 0, centerText = "", width = 150, height = 150) {
      d3.select(`#${containerId}`).html(""); // Limpiar contenedor primero
      
      const radius = Math.min(width, height) / 2;
      const svg = d3.select(`#${containerId}`)
        .append("svg")
        .attr("width", width)
        .attr("height", height)
        .append("g")
        .attr("transform", `translate(${width/2},${height/2})`);
      
      // Añadir título
      d3.select(`#${containerId}`)
        .insert("div", ":first-child")
        .attr("class", "chart-title")
        .text(title);
      
      const pie = d3.pie().value(d => d.value).sort(null);
      const arc = d3.arc()
        .innerRadius(radius * 0.6)
        .outerRadius(radius * 0.9);
      
      const arcs = svg.selectAll(".arc")
        .data(pie(data))
        .enter()
        .append("g")
        .attr("class", "arc");
      
      arcs.append("path")
        .attr("d", arc)
        .attr("fill", d => d.data.color)
        .attr("stroke", "white")
        .style("stroke-width", "2px");
      
      svg.append("text")
        .attr("text-anchor", "middle")
        .attr("dy", ".3em")
        .style("font-size", "20px")
        .style("font-weight", "bold")
        .text(centerText);
      
      const legend = d3.select(`#${containerId}`)
        .append("div")
        .style("display", "flex")
        .style("flex-wrap", "wrap")
        .style("justify-content", "center")
        .style("margin-top", "8px");

      data.forEach(d => {
        if(d.value > 0) {
          const formattedValue = showPercentage ? d.value.toFixed(decimals) + "%" : d.value;
          legend.append("div")
            .html(`
              <div style="display:flex; align-items:center; margin:2px 5px;">
                <div style="width:12px;height:12px;background:${d.color};margin-right:5px;"></div>
                ${d.label}: ${formattedValue}
              </div>
            `);
        }
      });
    }
    // Cargar datos desde GitHub
    function loadData() {
      // Usamos la ruta absoluta al repositorio para evitar problemas de CORS
      const repoName = window.location.pathname.split('/')[1] || 'tu-repositorio';
      const dataUrl = `/${repoName}/data.json`;
      
      d3.json(dataUrl)
        .then(data => {
          if (!data) throw new Error("El archivo data.json está vacío");
          
          // Convertir datos al formato de tabla
          const tabla = [
            ["ONR", "Descripción", "Fecha I.", "Estado actual", "Avance según plan", "Avance real", "Observaciones"],
            ...data.map(proyecto => [
              proyecto.ONR || "N/A",
              proyecto["Descripción"] || "",
              proyecto["Fecha I."] || "",
              proyecto["Estado actual"] || "Desconocido",
              proyecto["Avance según plan"] || 0,
              proyecto["Avance real"] || 0,
              proyecto.Observaciones || ""
            ])
          ];
          
          initDashboard(tabla);
        })
        .catch(error => {
          console.error("Error:", error);
          showError(`No se pudo cargar data.json: ${error.message}`);
        });
    }

    // Función principal del dashboard
    function initDashboard(tabla) {
      // 1. Calcular el avance general promedio
      const avances = tabla.slice(1).map(row => parseFloat(row[5])).filter(v => !isNaN(v));
      const totalAvance = avances.reduce((sum, val) => sum + val, 0);
      const avancePromedio = avances.length > 0 ? totalAvance / avances.length : 0;
      const avancePendiente = 100 - avancePromedio;

      // 2. Calcular distribución por estados
      const conteoEstados = { completados: 0, enProgreso: 0, retrasados: 0 };
      
      tabla.slice(1).forEach(row => {
        const estado = (row[3] || "").toLowerCase();
        if (estado.includes("completado")) conteoEstados.completados++;
        else if (estado.includes("progreso")) conteoEstados.enProgreso++;
        else if (estado.includes("retrasado") || estado.includes("stand by")) conteoEstados.retrasados++;
      });
      
      const totalProyectosEstado = conteoEstados.completados + conteoEstados.enProgreso + conteoEstados.retrasados;

      // Crear gráficos
      createDonutChart("avance-general-chart", [
        { label: "Avanzado", value: avancePromedio, color: "#4CAF50" },
        { label: "Pendiente", value: avancePendiente, color: "#F44336" }
      ], "Avance General Promedio", true, 0, `${avancePromedio.toFixed(0)}%`);

      createDonutChart("estados-chart", [
        { label: "Completados", value: conteoEstados.completados, color: "#4CAF50" },
        { label: "En progreso", value: conteoEstados.enProgreso, color: "#FFC107" },
        { label: "Retrasados", value: conteoEstados.retrasados, color: "#F44336" }
      ], "Distribución por Estado", false, 0, `${conteoEstados.completados}/${totalProyectosEstado}`);

    // Crear la tabla
    const table = d3.select("#dashboard").append("table").attr("class", "mi-tabla");
    const thead = table.append("thead");
    const tbody = table.append("tbody");

    // Encabezados
    thead.append("tr")
      .selectAll("th")
      .data(tabla[0].concat(["Avance gráfico"]))
      .enter()
      .append("th")
      .text(d => d);

    // Filas de datos
    const rows = tbody.selectAll("tr")
      .data(tabla.slice(1))
      .enter()
      .append("tr");

    // Celdas de datos
    rows.selectAll("td")
      .data(d => d.concat([null])) // Añadimos columna extra para el gráfico
      .enter()
      .append("td")
      .each(function(d, i) {
        // Estado con color
        if (i === 3) {
          d3.select(this)
            .style("background", estadoColor[d] || "#eee")
            .style("color", "#222")
            .text(d);
        }
        // Gráfico de barras horizontales
        else if (i === 7) {
          const row = d3.select(this);
          const plan = +d3.select(this.parentNode).datum()[4]; // Avance según plan (índice 4)
          const real = +d3.select(this.parentNode).datum()[5]; // Avance real (índice 5)
          
          const container = row.append("div").attr("class", "progress-container");
          
          container.append("div")
            .attr("class", "progress-plan")
            .style("width", plan + "%");
            
          container.append("div")
            .attr("class", "progress-real")
            .style("width", real + "%");
            
          container.append("div")
            .attr("class", "progress-label")
	    .style("color", real > 45 ? "white" : "black")  // Blanco si > 50%, negro si no
            .style("font-weight", "bold")
            .text(real + "%");
  
        }
        // Mostrar el avance según plan (columna 4) con el símbolo de porcentaje
        else if (i === 4) {
          d3.select(this).text(d + "%");
        }
        // Mostrar el avance real (columna 5) con el símbolo de porcentaje
        else if (i === 5) {
          d3.select(this).text(d + "%");
        }
        // Otras celdas normales
        else {
          d3.select(this).text(d);
        }
      });

    // Diagrama de barras inferior
    const barWidth = 1000, barHeight = 300;
    const dataBar = tabla.slice(1).map(d => ({
      proyecto: d[0],
      avance: d[5] // Usar Avance real (índice 5)
    }));

    const x = d3.scaleBand()
      .domain(dataBar.map(d => d.proyecto))
      .range([0, barWidth])
      .padding(0.5);

    const y = d3.scaleLinear()
      .domain([0, 100])
      .range([barHeight, 0]);

    // Aumentar el tamaño del SVG para acomodar las etiquetas rotadas
    const svgBar = d3.select("#dashboard")
      .append("svg")
      .attr("width", barWidth + 200)   // Aumenté el ancho para las etiquetas
      .attr("height", barHeight + 350)   // Aumenté la altura para las etiquetas
      .append("g")
      .attr("transform", "translate(100,100)");

    // Eje X
    svgBar.append("g")
      .attr("transform", `translate(0,${barHeight})`)
      .call(d3.axisBottom(x))
      .selectAll("text")
      .attr("transform", "rotate(90)")
      .attr("text-anchor", "start")
      .attr("dx", "0.8em")      // Ajuste horizontal
      .attr("dy", "0.2em")     // Ajuste vertical
      .style("font-size", "10px");

    // Eje Y
    svgBar.append("g")
      .call(d3.axisLeft(y).ticks(5).tickFormat(d => d + "%"));

    // Barras
    svgBar.selectAll(".bar")
      .data(dataBar)
      .enter()
      .append("rect")
      .attr("class", "bar")
      .attr("x", d => x(d.proyecto))
      .attr("y", d => y(d.avance))
      .attr("width", x.bandwidth())
      .attr("height", d => barHeight - y(d.avance))
      .attr("fill", "#1976d2");

    // Etiquetas encima de cada barra
    svgBar.selectAll(".bar-label")
      .data(dataBar)
      .enter()
      .append("text")
      .attr("class", "bar-label")
      .attr("x", d => x(d.proyecto) + x.bandwidth()/2)
      .attr("y", d => y(d.avance) - 5)
      .attr("text-anchor", "middle")
      .attr("fill", "#333")
      .attr("font-size", 10)
      .text(d => d.avance + "%");

    // Título del gráfico de barras
    svgBar.append("text")
      .attr("x", barWidth/2)
      .attr("y", -30)
      .attr("text-anchor", "middle")
      .attr("font-weight", "bold")
      .attr("font-size", 16)
      .attr("fill", "#1976d2")
      .text("Avance Real por ONR");
     }
    // Iniciar cuando el DOM esté listo
    document.addEventListener("DOMContentLoaded", loadData);
  </script>
</body>
</html>
